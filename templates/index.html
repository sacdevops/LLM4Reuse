<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>LLM4Reuse</title>

  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div id="uploadContainer" class="container">
  <h1>LLM4Reuse - Upload</h1>
  <p style="text-align:center;">Drag & drop XAML files here or click to select.</p>
  <div id="uploadArea" class="upload-area">Drop or Click</div>
  <div id="loadingSpinner" class="loading-spinner"></div>
  <input id="fileInput" type="file" name="files" multiple style="display:none;">
</div>

<div id="editorContainer" class="container hidden">
  <h1>LLM4Reuse Editor</h1>
  <div class="editor-layout">
    <div class="box">
        <div>
            <h3>Documentation</h3>
            <button class="button" onclick="downloadPDF()">Download PDF</button>
        </div>
      <pre class="white-space-pre" id="documentationBox"></pre>
      <br>
    </div>
    <div style="flex:2; display:flex; flex-direction:column;">
      <div class="chat-history" id="chatHistory"></div>
      <div class="prompt-area">
        <input class="prompt-input" type="text" id="promptInput" placeholder="Enter your prompt...">
        <button class="button" id="sendPromptBtn">Send</button>
      </div>
      <br>
    </div>
    <div class="box">
        <div>
            <h3>XAML Code</h3>
            <button class="button" onclick="downloadXAML()">Download XAML</button>
        </div>
      <pre class="white-space-pre" id="xamlBox"></pre>
    </div>
  </div>
</div>

<script>
  const uploadContainer = document.getElementById('uploadContainer');
  const editorContainer = document.getElementById('editorContainer');
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');

  const documentationBox = document.getElementById('documentationBox');
  const xamlBox = document.getElementById('xamlBox');
  const chatHistoryEl = document.getElementById('chatHistory');
  const promptInput = document.getElementById('promptInput');
  const sendPromptBtn = document.getElementById('sendPromptBtn');

  const loadingSpinner = document.getElementById('loadingSpinner');

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('hover');
  });
  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('hover');
  });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('hover');
    const files = e.dataTransfer.files;
    if(files.length) {
      uploadFiles(files);
    }
  });
  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });
  fileInput.addEventListener('change', () => {
    if(fileInput.files.length){
      uploadFiles(fileInput.files);
    }
  });

  function uploadFiles(files) {
    const formData = new FormData();
    for(let i=0; i<files.length; i++){
      formData.append('files', files[i]);
    }

    // Show loading spinner
    loadingSpinner.style.display = 'block';
    uploadArea.style.display = 'none';

    const xhr = new XMLHttpRequest();

    xhr.onload = function() {
      if (xhr.status === 200) {
        const data = JSON.parse(xhr.responseText);
        if(data.status === "ok") {
          setTimeout(() => {
            uploadContainer.classList.add('hidden');
            editorContainer.classList.remove('hidden');
            xamlBox.textContent = data.xaml_code || "";
            documentationBox.textContent = data.documentation || "";
          }, 1000);
        } else {
          resetUploadUI();
        }
      } else {
        resetUploadUI();
      }
    };

    xhr.onerror = function() {
      resetUploadUI();
    };

    xhr.open('POST', '/', true);
    xhr.send(formData);
  }

  function resetUploadUI() {
    setTimeout(() => {
      loadingSpinner.style.display = 'none';
      uploadArea.style.display = 'block';
    }, 2000);
  }

  sendPromptBtn.addEventListener('click', async () => {
    const userText = promptInput.value.trim();
    if(!userText) return;
    appendToChat('user', userText);
    promptInput.value = "";
    disableSend(true);

    const codeResp = await fetch('/extend_code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ prompt: userText })
    });
    const codeData = await codeResp.json();
    if(codeData.xaml_code) {
      xamlBox.textContent = codeData.xaml_code;
    }

    const docResp = await fetch('/generate_docs', { method: 'POST' });
    const docData = await docResp.json();
    if(docData.documentation) {
      documentationBox.textContent = docData.documentation;
    }

    appendToChat('assistant', "Code updated.");
    disableSend(false);
  });

  function appendToChat(role, text){
    const div = document.createElement('div');
    div.textContent = text;
    if(role === 'user') {
      div.className = 'message-user';
    } else {
      div.className = 'message-assistant';
    }
    chatHistoryEl.appendChild(div);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
  }
  function disableSend(state){
    sendPromptBtn.disabled = state;
    sendPromptBtn.textContent = state ? "Wait..." : "Send";
  }

  function downloadPDF(){
    
  }

  function confirmHandler(e){

  }
</script>

</body>
</html>
